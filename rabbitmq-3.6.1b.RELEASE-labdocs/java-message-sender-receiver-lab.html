<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>Chapter&nbsp;3.&nbsp;Java Message Sender and Receiver</title><link rel="stylesheet" type="text/css" href="css/html.css"><meta name="generator" content="DocBook XSL Stylesheets V1.79.1"><link rel="home" href="index.html" title="RabbitMQ - Lab Documentation"><link rel="up" href="index.html" title="RabbitMQ - Lab Documentation"><link rel="prev" href="installation-lab.html" title="Chapter&nbsp;2.&nbsp;Installation and Management"><link rel="next" href="message-routing-lab.html" title="Chapter&nbsp;4.&nbsp;Using the Full Routing Capabilities of RabbitMQ"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div xmlns="http://www.w3.org/TR/xhtml1/transitional" style="background-color:white;border:none;height:73px;border:none;"><a style="border:none;" href="http://www.rabbitmq.com/" title="RabbitMQ"><img style="border:none;" src="images/rabbitmq_logo_strap.png"></img></a><a style="border:none;" href="http://www.pivotal.io/" title="RabbitMQ by Pivotal"><img style="border:none;position:absolute;padding-top:5px;right:42px;" src="images/logo-pivotal-118x25.png"></img></a></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="java-message-sender-receiver-lab"></a>Chapter&nbsp;3.&nbsp;Java Message Sender and Receiver</h1></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="java-message-sender-receiver-lab-objective"></a>3.1.&nbsp;Objective</h2></div></div></div><p>In this lab, you will use the RabbitMQ&#8217;s Java binding to send and receive messages. The messages can either be consumed by subscription (asynchronous reception) or one-by-one consumption.</p><p>You&#8217;ll use a simple quotation use-case for this lab. </p><p>At the end of this lab, you&#8217;ll have a good understanding of how to use the Java binding.</p><p>This lab requires basic Java and Eclipse skills. If you&#8217;re not comfortable with these technologies, don&#8217;t hesitate to ask the instructor for a quick demo of Java development with Eclipse.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="java-message-sender-receiver-lab-setup"></a>3.2.&nbsp;Setting Up the Exchange and the Queue</h2></div></div></div><p>Create a <code class="code">quotations</code> fanout exchange, and bind it to a <code class="code">quotations</code> queue.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="java-message-sender-receiver-lab-sending-messages"></a>3.3.&nbsp;Sending Messages</h2></div></div></div><p>You&#8217;ll use a Java program with an infinite loop to send messages. Messages will be sent after every one second.</p><div class="orderedlist"><ol class="orderedlist compact" type="1"><li class="listitem"><p>Open the <code class="code">QuotationSender</code> class.</p></li><li class="listitem"><p>Write the Java code to connect to the broker, and create a channel.</p></li><li class="listitem"><p>Launch the program to test the connection.</p></li><li class="listitem"><p>Create an infinite loop (<code class="code">while(true)</code>).</p></li><li class="listitem"><p>In the loop, wait (use the <code class="code">letsWait()</code> method) and send a message to the <code class="code">quotations</code> 
					exchange with a routing key, namely <code class="code">nasq</code>. The payload of the message is the result 
					of a call to the <code class="code">next()</code> method of the <code class="code">QuotationService</code> (don&#8217;t hesitate to take a look 
					at the code of the <code class="code">QuotationService)</code>.</p></li><li class="listitem"><p>Execute the program.</p></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="java-message-sender-receiver-lab-checking-messages"></a>3.4.&nbsp;Checking Messages with the Management Plugin</h2></div></div></div><p>Let&#8217;s check if the messages arrived correctly in the queue.</p><div class="orderedlist"><ol class="orderedlist compact" type="1"><li class="listitem"><p>In the web UI of the management plugin, check the messages in the <code class="code">quotations</code> queue.</p></li><li class="listitem"><p>Purge the queue</p></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="java-message-sender-receiver-lab-asynchronous-consumption"></a>3.5.&nbsp;Asynchronous Consumption</h2></div></div></div><p>Write a Java program that displays the quotations on the console as soon as they arrive on the queue. 
			Asynchronous consumption is the simplest way to do that.</p><div class="orderedlist"><ol class="orderedlist compact" type="1"><li class="listitem"><p>Open the <code class="code">QuotationConsumer</code> class.</p></li><li class="listitem"><p>Write the Java code to asynchronously consume the messages and display the quotation on 
					the console (use the <code class="code">String(byte[]</code>) constructor to convert the payload into a Java <code class="code">String</code>).</p></li><li class="listitem"><p>Execute the sender program, and the consumer program (in any order). You should see the quotations on the console.</p></li></ol></div><p>Congrats! You&#8217;re done with the part of the lab.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="java-message-sender-receiver-lab-retrieving-messages"></a>3.6.&nbsp;Retrieving Messages</h2></div></div></div><p>You can explicitly ask for the messages with the basicGet method. If there&#8217;s no message on the queue, you&#8217;ll get null. 
			You will use the Java binding to send a message and receive it immediately afterwards. This time, you&#8217;ll be writing a JUnit test.</p><div class="orderedlist"><ol class="orderedlist compact" type="1"><li class="listitem"><p>Be sure to stop any Java program that could already be running and to purge
				the <code class="code">quotations</code> queue.</p></li><li class="listitem"><p>Open the <code class="code">SendingAndReceivingTest</code> class. The structure has already been provided, 
					and you just need to implement the <code class="code">sendAndReceiving()</code> method.</p></li><li class="listitem"><p>Connect to the broker and send a quotation to the quotations exchange (use the 
					<code class="code">QuotationService</code> to generate the quotation).</p></li><li class="listitem"><p>Run the test. With the management plugin, check the quotation is on the queue 
					(don&#8217;t forget to purge the queue afterwards).</p></li><li class="listitem"><p>After sending the message, do a <code class="code">basicGet()</code> on the queue to retrieve the message. 
					Write a while loop that checks whether the <code class="code">GetResponse</code> is <code class="code">null</code> or not, 
					and does a maximum of 5 attempts.</p></li><li class="listitem"><p>It&#8217;s time now for some JUnit assertions. After the reception, assert the 
					<code class="code">GetResponse</code> isn&#8217;t null with the <code class="code">Assert.assertNotNull</code> JUnit call. </p></li><li class="listitem"><p>Re-create the quotation from the payload of the received message, and compare it with the quotation you sent.</p></li><li class="listitem"><p>Run the test.</p></li></ol></div><p>Congratulations, you&#8217;re done with this lab.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="java-message-sender-receiver-lab-bonus"></a>3.7.&nbsp;Bonus</h2></div></div></div><p>Improve your test by purging the queue at the beginning. This will avoid the failure of the test, 
			if there are existing messages on the queue. You can also declare the queue, the exchange, and 
			the binding in the test. Remember that declarations are idempotent: it works even the resource 
			(exchange, queue) already exists, i.e. you don&#8217;t get an error saying there&#8217;s a conflict. The 
			limitation is the resource must be EXACTLY the same (e.g., you can&#8217;t declare a non-durable 
			<code class="code">quotations</code> queue if a durable <code class="code">quotations</code> queue already exists).</p></div></div><div xmlns="http://www.w3.org/TR/xhtml1/transitional" class="navfooter"><hr></hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="installation-lab.html">Prev</a>&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right">&nbsp;<a accesskey="n" href="message-routing-lab.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Chapter&nbsp;2.&nbsp;Installation and Management&nbsp;</td><td width="20%" align="center"><span style="color:white;font-size:90%;"><a href="http://www.pivotal.io/oss" title="RabbitMQ">RabbitMQ By Pivotal</a></span></td><td width="40%" align="right" valign="top">&nbsp;Chapter&nbsp;4.&nbsp;Using the Full Routing Capabilities of RabbitMQ</td></tr></table></div></body></html>