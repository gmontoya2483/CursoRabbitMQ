<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>Chapter&nbsp;10.&nbsp;Spring AMQP (optional)</title><link rel="stylesheet" type="text/css" href="css/html.css"><meta name="generator" content="DocBook XSL Stylesheets V1.79.1"><link rel="home" href="index.html" title="RabbitMQ - Lab Documentation"><link rel="up" href="index.html" title="RabbitMQ - Lab Documentation"><link rel="prev" href="securing-rabbitmq-lab.html" title="Chapter&nbsp;9.&nbsp;Securing RabbitMQ"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div xmlns="http://www.w3.org/TR/xhtml1/transitional" style="background-color:white;border:none;height:73px;border:none;"><a style="border:none;" href="http://www.rabbitmq.com/" title="RabbitMQ"><img style="border:none;" src="images/rabbitmq_logo_strap.png"></img></a><a style="border:none;" href="http://www.pivotal.io/" title="RabbitMQ by Pivotal"><img style="border:none;position:absolute;padding-top:5px;right:42px;" src="images/logo-pivotal-118x25.png"></img></a></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="spring-amqp-lab"></a>Chapter&nbsp;10.&nbsp;Spring AMQP (optional)</h1></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="spring-amqp-lab-objective"></a>10.1.&nbsp;Objective</h2></div></div></div><p>In this lab, you will use Spring AMQP to send and receive messages, just as in the 
        	first exercise.  Both synchronous and asynchronous message listeners using the AMQP 
        	template will be demonstrated.</p><p>You&#8217;ll use a simple quotation use-case for this lab. </p><p>At the end of this lab, you&#8217;ll have a good understanding of how to configure the 
			Spring AMQP Template for sending and receiving messages.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="spring-amqp-lab-setup"></a>10.2.&nbsp;Setting Up the Exchange and the Queue</h2></div></div></div><p>If they don't exist, re-create the <code class="code">quotations</code> fanout exchange, 
        	and bind it to a <code class="code">quotations</code> queue.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="spring-amqp-lab-sending-messages"></a>10.3.&nbsp;Sending Messages</h2></div></div></div><p>You&#8217;ll use the Spring AMQP Template with an infinite loop to send messages. 
			Messages will be sent after every one second.</p><div class="orderedlist"><ol class="orderedlist compact" type="1"><li class="listitem"><p>Open the <code class="code">SenderConfiguration</code> class.</p></li><li class="listitem"><p>Create a <code class="code">CachingConnectionFactory</code> Spring bean.</p></li><li class="listitem"><p>Create a <code class="code">RabbitTemplate</code> Spring bean and link it to the
				<code class="code">ConnectionFactory</code>.</p></li><li class="listitem"><p>Open the <code class="code">QuotationSender</code> class.</p></li><li class="listitem"><p>Write the Java code to fetch the <code class="code">RabbitTemplate</code> bean into a 
					local variable.  (Hint: Obtain it using the <code class="code">getBean()</code> method on the context.)</p></li><li class="listitem"><p>In the loop, send a message to the <code class="code">quotations</code> exchange with a routing key of <code class="code">nasq</code>, 
					using the <code class="code">RabbitTemplate convertAndSend()</code> method.  By using the <code class="code">convertAndSend()</code> method, 
					Spring AMQP will automatically convert the object into a byte array and 
					insert it as the message payload.</p></li><li class="listitem"><p>Execute the program.</p></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="spring-amqp-lab-checking-messages"></a>10.4.&nbsp;Checking Messages with the Management Plugin</h2></div></div></div><p>Let&#8217;s check if the messages arrived correctly in the queue.</p><div class="orderedlist"><ol class="orderedlist compact" type="1"><li class="listitem"><p>In the web UI of the management plugin, check the messages in the <code class="code">quotations</code> queue.</p></li><li class="listitem"><p>Stop the <code class="code">QuotationSender</code> and purge the queue</p></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="spring-amqp-lab-asynchronous-consumption"></a>10.5.&nbsp;Asynchronous Consumption</h2></div></div></div><p>Write a Spring AMQP message listener that displays the quotations on the console as soon as 
			they arrive on the queue. Asynchronous consumption is the simplest way to do that.</p><div class="orderedlist"><ol class="orderedlist compact" type="1"><li class="listitem"><p>Open the <code class="code">ConsumerConfiguration</code> class.</p></li><li class="listitem"><p>Just as in the previous section, create a <code class="code">CachingConnectionFactory</code> Spring bean.</p></li><li class="listitem"><p>Create a <code class="code">SimpleMessageListenerContainer</code> Spring bean and configure it
				to call the <code class="code">quotationMsgHandler</code> bean when messages end up in the
				<code class="code">quotations</code> queue.</p></li><li class="listitem"><p>Open the <code class="code">QuotationConsumer</code> class and take a look at the code. It creates a
				Spring application context from the <code class="code">ConsumerConfiguration</code> class. The message listener
				will kick in as soon as the application context starts.
				</p></li><li class="listitem"><p>Open the <code class="code">QuotationMsgHandler</code> class.  The <code class="code">onMessage()</code> method of this 
					class will be invoked whenever a new message is placed onto the queue. The content
					of the message is printed in the console.</p></li><li class="listitem"><p>Execute the sender program, and the consumer program (in any order). 
					You should see the quotations on the console.</p></li></ol></div><p>Congrats! You&#8217;re done with the part of the lab.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="spring-amqp-lab-retrieving-messages"></a>10.6.&nbsp;Retrieving Messages</h2></div></div></div><p>You can explicitly ask for the messages using the <code class="code">receiveAndConvert()</code> method 
			of the template. If there&#8217;s no message on the queue, you&#8217;ll get <code class="code">null</code>.</p><p>You will use the <code class="code">RabbitTemplate</code> to send a message and receive it immediately 
			afterwards. This time, you&#8217;ll be writing a JUnit test.</p><div class="orderedlist"><ol class="orderedlist compact" type="1"><li class="listitem"><p>Open the <code class="code">SendingAndReceivingTest</code> class. The structure has already been 
					provided, and you just need to implement the <code class="code">sendAndReceiving()</code> method.</p></li><li class="listitem"><p>Use the <code class="code">convertAndSend()</code> method on the <code class="code">RabbitTemplate</code> to 
					publish the quotation to the <code class="code">quotations</code> exchange.</p></li><li class="listitem"><p>After sending the message, call <code class="code">receiveAndConvert()</code> on the queue to retrieve the message.</p></li><li class="listitem"><p>Purge the queue if necessary.</p></li><li class="listitem"><p>Run the test.</p></li></ol></div><p>Congratulations, you&#8217;re done with this lab.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="spring-amqp-lab-bonus"></a>10.7.&nbsp;Bonus</h2></div></div></div><p>Start up the <code class="code">QuotationConsumer</code>, then stop the RabbitMQ server.  Notice how the 
			consumer automatically tries to reconnect to the server.  Now restart the RabbitMQ server, and 
			observe how the consumer then reconnects successfully.  It was not necessary to write any explicit
			code to reconnect -- the Spring AMQP Template handles it all for you out-of-the-box.</p></div></div><div xmlns="http://www.w3.org/TR/xhtml1/transitional" class="navfooter"><hr></hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="securing-rabbitmq-lab.html">Prev</a>&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right">&nbsp;</td></tr><tr><td width="40%" align="left" valign="top">Chapter&nbsp;9.&nbsp;Securing RabbitMQ&nbsp;</td><td width="20%" align="center"><span style="color:white;font-size:90%;"><a href="http://www.pivotal.io/oss" title="RabbitMQ">RabbitMQ By Pivotal</a></span></td><td width="40%" align="right" valign="top">&nbsp;</td></tr></table></div></body></html>